<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="/public/style.css" />
    <title>Pin required</title>
  </head>
  <body>
    <div class="container">
      <h2>Enter pincode</h2>
      <div class="code-container">
        <input
          type="number"
          class="code"
          placeholder="0"
          min="0"
          max="9"
          required
        />
        <input
          type="number"
          class="code"
          placeholder="0"
          min="0"
          max="9"
          required
        />
        <input
          type="number"
          class="code"
          placeholder="0"
          min="0"
          max="9"
          required
        />
        <input
          type="number"
          class="code"
          placeholder="0"
          min="0"
          max="9"
          required
        />
      </div>
      <small id="info"></small>
    </div>
    <script>
      const codes = document.querySelectorAll(".code");

      var pin = [];

      codes[0].focus();

      codes.forEach((code, idx) => {
        code.addEventListener("keydown", async (e) => {
          if (e.key >= 0 && e.key <= 9) {
            pin[idx] = e.key;
            codes[idx].value = "";
            if (idx < 3) {
              setTimeout(() => codes[idx + 1].focus(), 10);
            } else {
              setTimeout(() => document.activeElement.blur(), 10);
              await check();
            }
          } else if (e.key === "Backspace") {
            if (idx > 0) {
              setTimeout(() => codes[idx - 1].focus(), 10);
            }
          }
        });
      });

      async function check() {
        const requestUrl = "{{.Url}}/api/v1/url/{{.Code}}";

        const res = await fetch(requestUrl, {
          method: "POST",
          body: JSON.stringify({
            pin: pin.join(""),
          }),
        });

        if (res.status !== 200) {
          reset();
          return;
        }

        const url = await res.json();

        window.location.replace(url);
      }

      function reset() {
        for (let i = 0; i < codes.length; i++) {
          codes[i].value = "";
        }

        codes[0].focus();
      }
    </script>
  </body>
</html>
